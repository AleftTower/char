-- Xeno Script: /e char on 'G' press and Manual Toggle
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- متغير حالة لتفعيل/تعطيل السكربت يدوياً
local isScriptEnabled = true 

-- وظيفة لإرسال الرسالة في الشات (تدعم النظامين القديم والجديد)
local function sendChatMessage(message)
    -- محاولة استخدام نظام الشات القديم (Legacy Chat)
    local defaultChatSystem = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if defaultChatSystem then
        local sayMessageRequest = defaultChatSystem:FindFirstChild("SayMessageRequest")
        if sayMessageRequest then
            sayMessageRequest:FireServer(message, "All")
            return
        end
    end

    -- محاولة استخدام نظام الشات الجديد (TextChatService)
    if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
        local generalChannel = TextChatService:FindFirstChild("TextChannels") and TextChatService.TextChannels:FindFirstChild("RBXGeneral")
        if generalChannel then
            generalChannel:SendAsync(message)
            return
        end
    end
    
    warn("Could not find a supported chat system to send the command.")
end

-- وظيفة الكشف عن النقر والتحقق من اللاعب
local function handlePlayerClick()
    -- فقط عند الضغط على زر G، لا يوجد تحقق من gameProcessed هنا
    
    local targetPart = Mouse.Target
    
    if targetPart then
        local character = targetPart.Parent
        
        -- التحقق مما إذا كان الجزء المضغوط تابعاً لملحق (Accessory) أو أداة (Tool)
        if character and (character:IsA("Accessory") or character:IsA("Tool")) then
            character = character.Parent
        end

        -- محاولة العثور على اللاعب من الشخصية
        local targetPlayer = Players:GetPlayerFromCharacter(character)
        
        if targetPlayer and targetPlayer ~= LocalPlayer then -- تأكد من أنه ليس اللاعب المحلي
            local targetName = targetPlayer.Name
            -- تغيير الأمر إلى /e /char [اسم اللاعب]
            local command = "/e /char " .. targetName
            
            print("G key press detected! Sending command: " .. command)
            sendChatMessage(command)
        end
    end
end

-- وظيفة للتبديل بين تفعيل/تعطيل السكربت (مثلاً بزر P)
local function toggleScript()
    isScriptEnabled = not isScriptEnabled
    local status = isScriptEnabled and "مُفَعَّل (Enabled)" or "مُعَطَّل (Disabled)"
    
    StarterGui:SetCore("SendNotification", {
        Title = "Char Clicker Status";
        Text = "الحالة الجديدة: " .. status;
        Duration = 3;
        Sound = nil; -- إشعار بدون صوت
    })
    
    print("Script status changed to: " .. status)
end

-- وظيفة الكشف عن ضغطة زر 'G' أو 'P'
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    -- تجاهل ضغطة الزر إذا كانت معالجة بواسطة النظام (في شات أو واجهة مستخدم)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.G then
        if isScriptEnabled then
            -- يتم تنفيذ الوظيفة فقط إذا كان السكربت مُفَعَّلاً
            handlePlayerClick() 
        else
            print("Script is disabled. Press 'P' to enable it.")
        end
    elseif input.KeyCode == Enum.KeyCode.P then
        -- استخدام زر P للتبديل بين التشغيل والإيقاف
        toggleScript()
    end
end)

-- إرسال إشعار بأن السكربت يعمل
StarterGui:SetCore("SendNotification", {
    Title = "Char Clicker Active";
    Text = "مُفَعَّل. اضغط G على لاعب، أو P للتشغيل/الإيقاف";
    Duration = 5;
    Sound = nil; -- إشعار بدون صوت
})
